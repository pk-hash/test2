# Staging Environment: API Service
# Reduced resources for staging environment

nameOverride: api-service

replicaCount: 1

# Enable both nginx and NATS
nginx:
  enabled: true
  image:
    repository: nginx
    tag: "1.27.0-alpine"
    pullPolicy: IfNotPresent

  service:
    port: 80
    targetPort: 80

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

nats:
  enabled: true
  image:
    repository: nats
    tag: "2.10.20-alpine"
    pullPolicy: IfNotPresent

  service:
    client:
      port: 4222
      targetPort: 4222
    monitoring:
      port: 8222
      targetPort: 8222

  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

ingress:
  enabled: true
  className: nginx
  annotations:
    nginx.ingress.kubernetes.io/rate-limit: "50"
  hosts:
    - host: api-staging.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 85

podLabels:
  app: api-service
  tier: backend
  environment: staging

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8222"
  prometheus.io/path: "/metrics"

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - project
          - key: app
            operator: In
            values:
            - api-service
        topologyKey: kubernetes.io/hostname
